<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Machine</title>
    <style>
        body { 
            text-align: center; 
            font-family: Arial, sans-serif; 
            background-color: white; 
            color: black; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }
        .canvas-wrapper {
            position: relative;
        }
        canvas { 
            border: 1px solid black; 
            background-color: white; 
        }
        #fractalCanvas {
            width: 800px;
            height: 800px;
        }
        #editorCanvas {
            width: 300px;
            height: 300px;
        }
        .controls { 
            margin-top: 10px; 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 800px;
        }
        .editor-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        label {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <h1>Fractal Machine</h1>
    <div class="container">
        <div class="canvas-wrapper">
            <canvas id="fractalCanvas" width="800" height="800"></canvas>
        </div>
        <div class="editor-controls">
            <h3>Polygon Editor</h3>
            <canvas id="editorCanvas" width="300" height="300"></canvas>
            <button onclick="addPoint()">Add Point</button>
            <button onclick="clearPoints()">Clear Points</button>
            <button onclick="applyCustomPolygon()">Apply Polygon</button>
        </div>
    </div>
    <div class="controls">
        <label>Animation Speed: <input type="range" id="animationSpeed" min="0.1" max="5" value="1" step="0.1"></label>
        <label>Steps: <input type="number" id="steps" value="1" min="1" max="10"></label>
        <label>Iterations: <input type="number" id="iterations" value="5" min="1" max="10"></label>
        <label>Scale X: <input type="number" id="scaleX" value="1" step="0.1"></label>
        <label>Scale Y: <input type="number" id="scaleY" value="1" step="0.1"></label>
        <label>Rotation: <input type="number" id="rotation" value="30"></label>
        <label>Shear X: <input type="number" id="shearX" value="0" step="0.1"></label>
        <label>Shear Y: <input type="number" id="shearY" value="0" step="0.1"></label>
        <label>Offset X: <input type="number" id="offsetX" value="0"></label>
        <label>Offset Y: <input type="number" id="offsetY" value="0"></label>
        <button onclick="toggleInvertColors()">Invert Colors</button>
        <button onclick="startAnimation()">Start Animation</button>
        <button onclick="stopAnimation()">Stop Animation</button>
        <button onclick="setPolygon(3)">Triangle</button>
        <button onclick="setPolygon(4)">Square</button>
        <button onclick="setPolygon(5)">Pentagon</button>
        <button onclick="resetFractal()">Reset</button>
    </div>
    <script>
        const canvas = document.getElementById("fractalCanvas");
        const ctx = canvas.getContext("2d");
        const editorCanvas = document.getElementById("editorCanvas");
        const editorCtx = editorCanvas.getContext("2d");

        let points = [];
        let buildSteps = [];
        let currentStep = 0;
        let frame = 0;
        let invertColors = false;
        let animationFrame;
        let lastTimestamp = 0;
        let isDragging = false;
        let dragIndex = -1;

        // Initialize the editor
        function initializeEditor() {
            // Add event listeners for the editor canvas
            editorCanvas.addEventListener('mousedown', startDragging);
            editorCanvas.addEventListener('mousemove', drag);
            editorCanvas.addEventListener('mouseup', stopDragging);
            editorCanvas.addEventListener('mouseleave', stopDragging);
            drawEditor();
        }

        function startDragging(e) {
            const rect = editorCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (editorCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (editorCanvas.height / rect.height);

            points.forEach((point, index) => {
                const dx = point.x - x;
                const dy = point.y - y;
                if (dx * dx + dy * dy < 100) { // 10px radius for hit detection
                    isDragging = true;
                    dragIndex = index;
                }
            });
        }

        function drag(e) {
            if (!isDragging) return;
            
            const rect = editorCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (editorCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (editorCanvas.height / rect.height);
            
            points[dragIndex] = { x, y };
            drawEditor();
        }

        function stopDragging() {
            isDragging = false;
            dragIndex = -1;
        }

        function drawEditor() {
            editorCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
            
            // Draw grid
            editorCtx.strokeStyle = "#ddd";
            const gridSize = 30;
            for (let i = 0; i <= editorCanvas.width; i += gridSize) {
                editorCtx.beginPath();
                editorCtx.moveTo(i, 0);
                editorCtx.lineTo(i, editorCanvas.height);
                editorCtx.stroke();
            }
            for (let i = 0; i <= editorCanvas.height; i += gridSize) {
                editorCtx.beginPath();
                editorCtx.moveTo(0, i);
                editorCtx.lineTo(editorCanvas.width, i);
                editorCtx.stroke();
            }

            // Draw shape
            if (points.length > 1) {
                editorCtx.beginPath();
                editorCtx.strokeStyle = invertColors ? "white" : "black";
                editorCtx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    editorCtx.lineTo(points[i].x, points[i].y);
                }
                if (points.length > 2) {
                    editorCtx.closePath();
                }
                editorCtx.stroke();
            }

            // Draw points
            points.forEach((point, index) => {
                editorCtx.beginPath();
                editorCtx.fillStyle = invertColors ? "white" : "black";
                editorCtx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                editorCtx.fill();
                
                // Draw point indices
                editorCtx.fillStyle = invertColors ? "black" : "white";
                editorCtx.textAlign = "center";
                editorCtx.textBaseline = "middle";
                editorCtx.fillText(index + 1, point.x, point.y);
            });
        }

        function addPoint() {
            const centerX = editorCanvas.width / 2;
            const centerY = editorCanvas.height / 2;
            const offset = points.length * 20; // Offset each new point slightly
            points.push({ 
                x: centerX + offset, 
                y: centerY + offset 
            });
            drawEditor();
        }

        function clearPoints() {
            points = [];
            drawEditor();
        }

        [Rest of the previous code remains the same]

        // Initialize everything
        initializeEditor();
        resetFractal();
    </script>
</body>
</html>
