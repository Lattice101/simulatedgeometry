<!DOCTYPE html>
<html lang="en">
<!-- Previous head content remains the same until style section -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Machine</title>
    <style>
        body { 
            text-align: center; 
            font-family: Arial, sans-serif; 
            background-color: black; 
            color: white; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            gap: 20px;
            margin: 20px;
        }
        .canvas-wrapper {
            position: relative;
        }
        canvas { 
            border: 1px solid white; 
            background-color: black; 
        }
        #fractalCanvas {
            width: 800px;
            height: 800px;
        }
        #editorCanvas {
            width: 300px;
            height: 300px;
        }
        .controls { 
            margin-top: 10px; 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            max-width: 800px;
        }
        .editor-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .zoom-btn {
            width: 30px;
            height: 30px;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .zoom-btn:hover {
            background: rgba(50, 50, 50, 0.7);
        }
        label {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <h1>Fractal Machine</h1>
    <div class="container">
        <div class="canvas-wrapper">
            <canvas id="fractalCanvas" width="800" height="800"></canvas>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="adjustZoom(1.2)">+</button>
                <button class="zoom-btn" onclick="adjustZoom(0.8)">-</button>
            </div>
        </div>
        <div class="editor-controls">
            <h3>Polygon Editor</h3>
            <canvas id="editorCanvas" width="300" height="300"></canvas>
            <button onclick="addPoint()">Add Point</button>
            <button onclick="clearPoints()">Clear Points</button>
            <button onclick="applyCustomPolygon()">Apply Polygon</button>
        </div>
    </div>
    <div class="controls">
        <label>Animation Speed: <input type="range" id="animationSpeed" min="0.1" max="5" value="0.1" step="0.1"></label>
        <label>Iterations: <input type="number" id="iterations" value="5" min="1" max="10"></label>
        <label>Scale X: <input type="number" id="scaleX" value="1" step="0.1"></label>
        <label>Scale Y: <input type="number" id="scaleY" value="1" step="0.1"></label>
        <label>Scale Z: <input type="number" id="scaleZ" value="1" step="0.1"></label>
        <label>Rotation: <input type="number" id="rotation" value="30"></label>
        <label>Shear X: <input type="number" id="shearX" value="0" step="0.1"></label>
        <label>Shear Y: <input type="number" id="shearY" value="0" step="0.1"></label>
        <label>Shear Z: <input type="number" id="shearZ" value="0" step="0.1"></label>
        <label>Offset X: <input type="number" id="offsetX" value="0"></label>
        <label>Offset Y: <input type="number" id="offsetY" value="0"></label>
        <button onclick="toggleInvertColors()">Light Mode</button>
        <button onclick="startAnimation()">Start Animation</button>
        <button onclick="stopAnimation()">Stop Animation</button>
        <button onclick="setPolygon(3)">Triangle</button>
        <button onclick="setPolygon(4)">Square</button>
        <button onclick="setPolygon(5)">Pentagon</button>
        <button onclick="resetFractal()">Reset</button>
    </div>
<script>
// Previous variable declarations remain the same, adding:
let zoomLevel = 1;
let invertColors = true; // Start inverted by default

// Update defaultValues object
let defaultValues = {
    animationSpeed: 0.1,
    iterations: 5,
    scaleX: 1,
    scaleY: 1,
    scaleZ: 1,
    rotation: 30,
    shearX: 0,
    shearY: 0,
    shearZ: 0,
    offsetX: 0,
    offsetY: 0
};

// Add zoom function
function adjustZoom(factor) {
    zoomLevel *= factor;
    resetFractal();
}

// Update applyTransform to include Z-axis
function applyTransform(x, y, scaleX, scaleY, scaleZ, rotation, shearX, shearY, shearZ, offsetX, offsetY) {
    const cos = Math.cos(rotation * Math.PI / 180);
    const sin = Math.sin(rotation * Math.PI / 180);
    
    // Apply Z-axis transformations
    const zFactor = scaleZ + (x * shearZ) / 1000;
    
    return {
        x: (x * cos * scaleX + y * sin * scaleX + shearX * y + offsetX) * zFactor * zoomLevel,
        y: (-x * sin * scaleY + y * cos * scaleY + shearY * x + offsetY) * zFactor * zoomLevel
    };
}

// Update drawFractalRecursive to include Z-axis
function drawFractalRecursive(x, y, size, angle, iterations) {
    if (iterations === 0) return;
    
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle * Math.PI / 180);
    drawPolygon(0, 0, size * zoomLevel, polygonSides);
    ctx.restore();

    const scaleX = parseFloat(document.getElementById("scaleX").value);
    const scaleY = parseFloat(document.getElementById("scaleY").value);
    const scaleZ = parseFloat(document.getElementById("scaleZ").value);
    const rotation = parseFloat(document.getElementById("rotation").value) + frame;
    const shearX = parseFloat(document.getElementById("shearX").value);
    const shearY = parseFloat(document.getElementById("shearY").value);
    const shearZ = parseFloat(document.getElementById("shearZ").value);
    const offsetX = parseFloat(document.getElementById("offsetX").value);
    const offsetY = parseFloat(document.getElementById("offsetY").value);

    const transformed1 = applyTransform(x, y, scaleX, scaleY, scaleZ, rotation, shearX, shearY, shearZ, offsetX, offsetY);
    const transformed2 = applyTransform(x, y, scaleX, scaleY, scaleZ, -rotation, shearX, shearY, shearZ, -offsetX, -offsetY);
    
    drawFractalRecursive(transformed1.x, transformed1.y, size * scaleX, angle + rotation, iterations - 1);
    drawFractalRecursive(transformed2.x, transformed2.y, size * scaleY, angle - rotation, iterations - 1);
}

// Update toggleInvertColors to invert the behavior
function toggleInvertColors() {
    invertColors = !invertColors;
    document.body.style.backgroundColor = invertColors ? "black" : "white";
    document.body.style.color = invertColors ? "white" : "black";
    canvas.style.backgroundColor = invertColors ? "black" : "white";
    editorCanvas.style.backgroundColor = invertColors ? "black" : "white";
    canvas.style.borderColor = invertColors ? "white" : "black";
    editorCanvas.style.borderColor = invertColors ? "white" : "black";
    
    // Update zoom button styles
    const zoomBtns = document.querySelectorAll('.zoom-btn');
    zoomBtns.forEach(btn => {
        btn.style.color = invertColors ? "white" : "black";
        btn.style.borderColor = invertColors ? "white" : "black";
        btn.style.background = invertColors ? "rgba(0, 0, 0, 0.7)" : "rgba(255, 255, 255, 0.7)";
    });
    
    drawEditor();
    resetFractal();
}

// The rest of the code remains the same...

// Initialize everything
initializeEditor();
resetFractal();
</script>
</body>
</html>
